require_relative 'config'
require_relative 'page'
require_relative 'sprockets'

module Sinatra
  module Pubba
    class Site
      class << self

        begin
          require 'r18n-desktop'
          include R18n::Helpers
        rescue Exception => e
        end

        attr_reader :asset_handler, :asset_types
        attr_reader :script_asset_folder, :style_asset_folder
        attr_reader :script_public_folder, :style_public_folder

        attr_reader :r18n, :disclaimer


        def configure(app)
          settings = app.settings

          configure_asset_handler(settings)

          asset_configuration = Sinatra::Pubba::Config.new(settings.pubba_config)

          asset_configuration.process do |page, config|

          end

          pages.each{|n, p| p.assetize }

          compile_assets(app)

          @script_public_folder = File.join(app.settings.public_folder, 'javascripts')
          @style_public_folder = File.join(app.settings.public_folder, 'stylesheets')
          @script_asset_folder = File.join(app.settings.asset_folder, 'javascripts')
          @style_asset_folder = File.join(app.settings.asset_folder, 'stylesheets')
          @asset_types = {'styles' => @style_asset_folder,
                          'head_scripts' => @script_asset_folder,
                          'body_scripts' => @script_asset_folder}


          @disclaimer = <<TEXT
// This file is automatically generated from the contents
// in #{Site.config_file}
//
TEXT

          R18n.from_env app.settings.r18n_default || 'en'
          @r18n =  R18n::I18n.new([app.settings.r18n_default || 'en'], 'translations/')
        end

        def configure_asset_handler(settings)
          asset_handler = settings.pubba_asset_handler || SprocketHandler
          asset_handler.asset_paths 'app/assets/stylesheets', 'app/assets/javascripts'
        end

        def global_configuration=(hsh)
          @global_configuration = hsh
        end

        def global_configuration
          @global_configuration ||= {}
        end

        def process_yaml
          yaml = Psych.load_file(settings.pubba_config)

          Site.global_configuration = yaml.delete("global")

          yaml.each do |page, config|
            Site.add_page(page, config)
          end
        end

        def page(name)
          pages[name]
        end

        def pages
          @pages ||= {}
        end

        def add_page(name, hash)
          page = Page.new(name, global_configuration)

          asset_types.keys.each do |asset|
            page.add_asset(asset, hash[asset]) if hash[asset]
          end

          pages[name] = page
        end

        private

        def compile_assets(app)
          process_assets(script_asset_folder, script_public_folder)
          process_assets(style_asset_folder, style_public_folder)
        end

        def process_assets(from_folder, to_folder)
          Dir.glob("#{from_folder}/*.*") do |file|
            asset = sprockets.find_asset(file)
            asset.write_to "#{to_folder}/#{File.basename(file)}"
          end
        end

      end #class block
    end # Site
  end # Pubba
end # Sinatra
